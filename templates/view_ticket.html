{% extends "base.html" %}

{% block content %}
<div class="mb-3">
    <a href="javascript:history.back()" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-1"></i>العودة
    </a>
</div>

{# تحضير بيانات البلاغ والأولويات #}
<script type="text/javascript">
    // تحضير ألوان وبيانات الأولويات
    var ticketData = {
        "priority": "{{ ticket.priority.name }}",
        "priorityColor": "{{ ticket.priority.color }}"
    };
</script>

<div class="row">
    <!-- تفاصيل البلاغ -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-ticket-alt me-2"></i>
                    {% if ticket.title %}
                    بلاغ #{{ ticket.id }}: {{ ticket.title }}
                    {% else %}
                    بلاغ #{{ ticket.id }}
                    {% endif %}
                </h5>
                <span class="badge
                    {% if ticket.status.name == 'جديد' %}bg-danger
                    {% elif ticket.status.name == 'قيد المعالجة' %}bg-warning text-dark
                    {% elif ticket.status.name == 'مكتمل' %}bg-success
                    {% elif ticket.status.name == 'مغلق' %}bg-secondary
                    {% endif %}">
                    {{ ticket.status.name }}
                </span>
            </div>
            <div class="card-body">
                <!-- معلومات القسم والإدارة -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="ticket-info">
                            <strong>الإدارة:</strong> {{ ticket.department.name if ticket.department else 'غير محدد' }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="ticket-info">
                            <strong>القسم:</strong> {{ ticket.section.name if ticket.section else 'غير محدد' }}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <!-- المعلومات الأساسية -->
                    <div class="col-md-6">
                        <div class="ticket-info">
                            <strong>المنشئ:</strong> {{ ticket.creator.name }}
                        </div>
                        <div class="ticket-info">
                            <strong>تاريخ الإنشاء:</strong> {{ ticket.created_at.strftime('%Y/%m/%d %H:%M') }}
                        </div>
                        <div class="ticket-info">
                            <strong>الموعد النهائي:</strong>
                            {% if ticket.due_date %}
                                <span class="{% if ticket.is_overdue() %}text-danger fw-bold{% endif %}">
                                    {{ ticket.due_date.strftime('%Y/%m/%d %H:%M') }}
                                    {% if ticket.is_overdue() %}
                                        <i class="fas fa-exclamation-triangle ms-1"></i>
                                    {% endif %}
                                </span>
                            {% else %}
                                <span class="text-muted">غير محدد</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- معلومات التصنيف -->
                    <div class="col-md-6">
                        <div class="ticket-info">
                            <strong>التصنيف:</strong> {{ ticket.category.name }}
                            {% if ticket.subcategory %}
                                <span class="badge bg-secondary ms-1">{{ ticket.subcategory.name }}</span>
                            {% endif %}
                        </div>
                        <div class="ticket-info">
                            <strong>الأولوية:</strong>
                            <span class="badge priority-badge" data-priority="{{ ticket.priority.name }}">
                                {% if "خلال" in ticket.priority.name %}
                                    {{ ticket.priority.name }}
                                {% elif ticket.priority.name == "منخفضة" and ticket.due_date %}
                                    {% set days_diff = ((ticket.due_date - ticket.created_at).total_seconds() / 86400)|round|int %}
                                    {% if days_diff > 0 %}
                                        خلال {{ days_diff }} يوم
                                    {% else %}
                                        {{ ticket.priority.name }}
                                    {% endif %}
                                {% else %}
                                    {{ ticket.priority.name }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="ticket-info">
                            <strong>فني الصيانة:</strong>
                            {% if ticket.assignee %}
                                {{ ticket.assignee.name }}
                            {% else %}
                                <span class="text-muted">غير معين</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- وصف المشكلة -->
                <h6 class="fw-bold mb-2">وصف المشكلة:</h6>
                <div class="p-3 bg-light rounded mb-4">
                    {{ ticket.description | replace('\n', '<br>') | safe }}
                </div>

                <!-- المرفقات -->
                {% if ticket.attachments.count() > 0 %}
                <h6 class="fw-bold mb-2">المرفقات:</h6>
                <div class="row mb-4">
                    {% for attachment in ticket.attachments %}
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center p-2">
                                {% if attachment.file_type and attachment.file_type.startswith('image/') %}
                                    <a href="javascript:void(0)" 
                                       data-url="{{ url_for('view_attachment', attachment_id=attachment.id) }}"
                                       data-type="{{ attachment.file_type }}"
                                       data-filename="{{ attachment.filename }}"
                                       class="preview-attachment-link d-block">
                                        <img src="{{ url_for('view_attachment', attachment_id=attachment.id) }}" 
                                             alt="{{ attachment.filename }}" 
                                             class="img-fluid attachment-thumbnail mb-2" 
                                             style="max-height: 120px;">
                                    </a>
                                {% elif attachment.file_type and 'pdf' in attachment.file_type %}
                                    <a href="javascript:void(0)" 
                                       data-url="{{ url_for('view_attachment', attachment_id=attachment.id) }}"
                                       data-type="{{ attachment.file_type }}"
                                       data-filename="{{ attachment.filename }}"
                                       class="preview-attachment-link d-block">
                                        <i class="fas fa-file-pdf fa-4x text-danger mb-2"></i>
                                    </a>
                                {% elif attachment.file_type and ('word' in attachment.file_type or 'document' in attachment.file_type) %}
                                    <i class="fas fa-file-word fa-4x text-primary mb-2"></i>
                                {% elif attachment.file_type and ('excel' in attachment.file_type or 'spreadsheet' in attachment.file_type) %}
                                    <i class="fas fa-file-excel fa-4x text-success mb-2"></i>
                                {% else %}
                                    <i class="fas fa-file fa-4x text-secondary mb-2"></i>
                                {% endif %}
                                <p class="small text-truncate mb-1">{{ attachment.filename }}</p>
                                <div class="btn-group btn-group-sm w-100">
                                    <a href="{{ url_for('download_attachment', attachment_id=attachment.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> تحميل
                                    </a>
                                    <a href="javascript:void(0)" 
                                       data-url="{{ url_for('view_attachment', attachment_id=attachment.id) }}"
                                       data-type="{{ attachment.file_type }}"
                                       data-filename="{{ attachment.filename }}"
                                       class="preview-attachment-link btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-eye"></i> معاينة
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- التعليقات -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>التعليقات
                    <span class="badge bg-secondary ms-2">{{ comments | length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="comment-box">
                        <div class="comment-header">
                            <div>
                                <strong>{{ comment.user.name }}</strong>
                                <span class="badge {% if comment.user.user_type == 'admin' %}bg-danger
                                      {% elif comment.user.user_type == 'maintenance' %}bg-success
                                      {% else %}bg-primary{% endif %} ms-2">
                                    {% if comment.user.user_type == 'admin' %}
                                        مدير
                                    {% elif comment.user.user_type == 'maintenance' %}
                                        فني
                                    {% else %}
                                        موظف
                                    {% endif %}
                                </span>
                            </div>
                            <div>{{ comment.created_at.strftime('%Y/%m/%d %H:%M') }}</div>
                        </div>
                        <div class="comment-content mt-2">
                            {{ comment.content | replace('\n', '<br>') | safe }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comments text-muted fa-3x mb-3"></i>
                        <p>لا توجد تعليقات حتى الآن</p>
                    </div>
                {% endif %}
                
                <!-- تحديث نموذج إضافة تعليق -->
                <form action="{{ url_for('add_comment', ticket_id=ticket.id) }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="content" class="form-label">إضافة تعليق:</label>
                        <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="comment_attachments" class="form-label">المرفقات (اختياري)</label>
                        <input type="file" class="form-control" id="comment_attachments" name="comment_attachments" multiple>
                        <div class="form-text">يمكنك إرفاق ملفات مع التعليق (الحد الأقصى 2 ملفات)</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>إرسال
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- الإجراءات والمعلومات الإضافية -->
    <div class="col-md-4">
        <!-- الإجراءات -->
        {% set current_user = get_current_user() %}
        
        {% if current_user.user_type == 'admin' %}
        <!-- تعيين فني صيانة (للمدير فقط) -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-user-cog me-2"></i>تعيين فني</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('assign_ticket', ticket_id=ticket.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="maintenance_id" class="form-label">اختر فني الصيانة:</label>
                        <select class="form-select" id="maintenance_id" name="maintenance_id" required>
                            <option value="" selected disabled>-- اختر فني الصيانة --</option>
                            {% for staff in maintenance_staff %}
                            <option value="{{ staff.id }}" {% if ticket.assigned_to_id == staff.id %}selected{% endif %}>
                                {{ staff.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i>تعيين
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        {% if current_user.user_type == 'maintenance' and current_user.id == ticket.assigned_to_id or current_user.user_type == 'admin' %}
        <!-- تحديث الحالة (للفني أو المدير) -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>تحديث الحالة</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('change_status', ticket_id=ticket.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="status_id" class="form-label">الحالة الجديدة:</label>
                        <select class="form-select" id="status_id" name="status_id" required>
                            {% for status in statuses %}
                            <option value="{{ status.id }}" {% if ticket.status_id == status.id %}selected{% endif %}>
                                {{ status.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-warning text-dark">
                            <i class="fas fa-sync-alt me-1"></i>تحديث الحالة
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- معلومات زمنية -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>معلومات زمنية</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        تاريخ الإنشاء
                        <span>{{ ticket.created_at.strftime('%Y/%m/%d %H:%M') }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        آخر تحديث
                        <span>{{ ticket.updated_at.strftime('%Y/%m/%d %H:%M') }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        الموعد النهائي
                        {% if ticket.due_date %}
                            <span class="{% if ticket.is_overdue() %}text-danger fw-bold{% endif %}">
                                {{ ticket.due_date.strftime('%Y/%m/%d %H:%M') }}
                                {% if ticket.is_overdue() %}
                                    <i class="fas fa-exclamation-triangle ms-1"></i>
                                {% endif %}
                            </span>
                        {% else %}
                            <span class="text-muted">غير محدد</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        وقت الاستجابة
                        {% if "خلال" in ticket.priority.name %}
                            <span>{{ (ticket.priority.response_time / 24)|round|int }} يوم</span>
                        {% else %}
                            <span>{{ ticket.priority.response_time }} ساعة</span>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- نافذة معاينة المرفقات -->
<div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attachmentPreviewModalLabel">معاينة المرفق</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body text-center" id="attachmentPreviewContent">
                <!-- سيتم عرض محتوى المرفق هنا -->
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" id="attachmentDownloadLink">
                    <i class="fas fa-download me-1"></i>تحميل
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // تطبيق ألوان الأولويات
    document.querySelectorAll('.priority-badge').forEach(badge => {
        badge.style.backgroundColor = ticketData.priorityColor;
    });
    
    // إضافة معالج حدث لروابط المعاينة
    document.querySelectorAll('.preview-attachment-link').forEach(link => {
        link.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            const type = this.getAttribute('data-type');
            const filename = this.getAttribute('data-filename');
            previewAttachment(url, type, filename);
        });
    });
});

// دالة لعرض المرفق
function previewAttachment(url, type, filename) {
    const previewContent = document.getElementById('attachmentPreviewContent');
    const modalTitle = document.getElementById('attachmentPreviewModalLabel');
    const downloadLink = document.getElementById('attachmentDownloadLink');
    
    // تعيين عنوان النافذة
    modalTitle.textContent = filename;
    
    // تعيين رابط التحميل
    downloadLink.href = url + '?download=true';
    
    // تفريغ محتوى المعاينة
    previewContent.innerHTML = '';
    
    // عرض المرفق حسب نوعه
    if (type && type.startsWith('image/')) {
        // إذا كان صورة
        const img = document.createElement('img');
        img.src = url;
        img.alt = filename;
        img.className = 'img-fluid';
        img.style.maxHeight = '70vh';
        previewContent.appendChild(img);
    } else if (type && type.includes('pdf')) {
        // إذا كان PDF
        const embed = document.createElement('embed');
        embed.src = url;
        embed.type = 'application/pdf';
        embed.style.width = '100%';
        embed.style.height = '70vh';
        previewContent.appendChild(embed);
    } else {
        // إذا كان نوع آخر لا يمكن معاينته
        const icon = document.createElement('i');
        
        if (type && type.includes('word')) {
            icon.className = 'fas fa-file-word fa-5x text-primary mb-3';
        } else if (type && type.includes('document')) {
            icon.className = 'fas fa-file-word fa-5x text-primary mb-3';
        } else if (type && type.includes('excel')) {
            icon.className = 'fas fa-file-excel fa-5x text-success mb-3';
        } else if (type && type.includes('spreadsheet')) {
            icon.className = 'fas fa-file-excel fa-5x text-success mb-3';
        } else if (type && type.includes('zip')) {
            icon.className = 'fas fa-file-archive fa-5x text-warning mb-3';
        } else if (type && type.includes('compressed')) {
            icon.className = 'fas fa-file-archive fa-5x text-warning mb-3';
        } else {
            icon.className = 'fas fa-file fa-5x text-secondary mb-3';
        }
        
        previewContent.appendChild(icon);
        
        const message = document.createElement('p');
        message.textContent = 'لا يمكن معاينة هذا النوع من الملفات. يرجى تحميل الملف لفتحه.';
        previewContent.appendChild(message);
    }
    
    // فتح النافذة
    const previewModal = new bootstrap.Modal(document.getElementById('attachmentPreviewModal'));
    previewModal.show();
}
</script>
{% endblock %}