{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">إدارة المستفيدين</h2>

<!-- أزرار الإضافة والاستيراد/التصدير -->
<div class="mb-4">
    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addBeneficiaryModal">
        <i class="fas fa-user-plus me-1"></i>إضافة مستفيد جديد
    </button>
    
    <div class="btn-group me-2">
        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-file-import me-1"></i>استيراد / تصدير
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importBeneficiariesModal">
                    <i class="fas fa-file-import me-1"></i>استيراد من Excel
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="{{ url_for('export_beneficiaries') }}">
                    <i class="fas fa-file-export me-1"></i>تصدير إلى Excel
                </a>
            </li>
        </ul>
    </div>
    
    <a href="{{ url_for('create_ticket') }}" class="btn btn-outline-secondary">
        <i class="fas fa-ticket-alt me-1"></i>إنشاء بلاغ
    </a>
</div>

<!-- قائمة المستفيدين -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">المستفيدون المسجلون</h5>
        <span class="badge bg-secondary">{{ beneficiaries|length }} مستفيد</span>
    </div>
    <div class="card-body p-0">
        {% if beneficiaries %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">الاسم</th>
                        <th scope="col">رقم الجوال</th>
                        <th scope="col">البلاغات</th>
                        <th scope="col">الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for beneficiary in beneficiaries %}
                    <tr>
                        <th scope="row">{{ beneficiary.id }}</th>
                        <td>{{ beneficiary.name }}</td>
                        <td>{{ beneficiary.phone or '-' }}</td>
                        <td>{{ beneficiary.tickets.count() }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning edit-beneficiary-btn" 
                                    data-id="{{ beneficiary.id }}"
                                    data-name="{{ beneficiary.name }}"
                                    data-phone="{{ beneficiary.phone }}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editBeneficiaryModal">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-beneficiary-btn" 
                                    data-id="{{ beneficiary.id }}"
                                    data-name="{{ beneficiary.name }}"
                                    data-tickets="{{ beneficiary.tickets.count() }}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteBeneficiaryModal">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center p-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <p class="lead">لا يوجد مستفيدين حالياً</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- نافذة إضافة مستفيد -->
<div class="modal fade" id="addBeneficiaryModal" tabindex="-1" aria-labelledby="addBeneficiaryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addBeneficiaryModalLabel">إضافة مستفيد جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{{ url_for('admin_add_beneficiary') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">الاسم</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">رقم الجوال</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">إضافة</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- نافذة تعديل المستفيد -->
<div class="modal fade" id="editBeneficiaryModal" tabindex="-1" aria-labelledby="editBeneficiaryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="editBeneficiaryModalLabel">تعديل المستفيد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{{ url_for('admin_edit_beneficiary') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" id="edit_beneficiary_id" name="beneficiary_id">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">الاسم</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_phone" class="form-label">رقم الجوال</label>
                        <input type="tel" class="form-control" id="edit_phone" name="phone">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- نافذة حذف المستفيد -->
<div class="modal fade" id="deleteBeneficiaryModal" tabindex="-1" aria-labelledby="deleteBeneficiaryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteBeneficiaryModalLabel">حذف المستفيد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{{ url_for('admin_delete_beneficiary') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <input type="hidden" id="delete_beneficiary_id" name="beneficiary_id">
                    <p>هل أنت متأكد من حذف المستفيد <strong id="delete_beneficiary_name"></strong>؟</p>
                    <div id="beneficiary_has_tickets_warning" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        تحذير: هذا المستفيد مرتبط بـ <strong id="beneficiary_tickets_count"></strong> بلاغ. سيتم إزالة الارتباط من البلاغات.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger">تأكيد الحذف</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- نافذة استيراد المستفيدين -->
<div class="modal fade" id="importBeneficiariesModal" tabindex="-1" aria-labelledby="importBeneficiariesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="importBeneficiariesModalLabel">استيراد المستفيدين</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form action="{{ url_for('import_beneficiaries') }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="import_file" class="form-label">اختر ملف Excel</label>
                        <input type="file" class="form-control" id="import_file" name="file" accept=".xlsx" required>
                    </div>
                    <div class="alert alert-info">
                        <h6>تنسيق الملف المطلوب:</h6>
                        <p class="mb-0">يجب أن يكون الملف بتنسيق XLSX ويحتوي على العناوين التالية: الاسم، رقم الجوال</p>
                        <p class="mb-0 mt-2">يمكنك تحميل <a href="{{ url_for('export_beneficiaries') }}" class="alert-link">قالب نموذجي</a> للملء</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success">استيراد</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تعبئة بيانات المستفيد في نافذة التعديل
    const editButtons = document.querySelectorAll('.edit-beneficiary-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const beneficiaryId = this.getAttribute('data-id');
            const beneficiaryName = this.getAttribute('data-name');
            const phone = this.getAttribute('data-phone');
            
            document.getElementById('edit_beneficiary_id').value = beneficiaryId;
            document.getElementById('edit_name').value = beneficiaryName;
            document.getElementById('edit_phone').value = phone || '';
        });
    });
    
    // تعبئة بيانات المستفيد في نافذة الحذف
    const deleteButtons = document.querySelectorAll('.delete-beneficiary-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const beneficiaryId = this.getAttribute('data-id');
            const beneficiaryName = this.getAttribute('data-name');
            const ticketsCount = parseInt(this.getAttribute('data-tickets'));
            
            document.getElementById('delete_beneficiary_id').value = beneficiaryId;
            document.getElementById('delete_beneficiary_name').textContent = beneficiaryName;
            document.getElementById('beneficiary_tickets_count').textContent = ticketsCount;
            
            // إظهار/إخفاء تحذير البلاغات
            const warningDiv = document.getElementById('beneficiary_has_tickets_warning');
            if (ticketsCount > 0) {
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}